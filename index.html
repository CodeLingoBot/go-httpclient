<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>go-httpclient by mreiferson</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <script src="javascripts/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>go-httpclient</h1>
        <p>a Go HTTP client with timeouts</p>
        <p class="view"><a href="https://github.com/mreiferson/go-httpclient">View the Project on GitHub <small>mreiferson/go-httpclient</small></a></p>
        <ul>
          <li><a href="https://github.com/mreiferson/go-httpclient/zipball/master">Download <strong>ZIP File</strong></a></li>
          <li><a href="https://github.com/mreiferson/go-httpclient/tarball/master">Download <strong>TAR Ball</strong></a></li>
          <li><a href="https://github.com/mreiferson/go-httpclient">View On <strong>GitHub</strong></a></li>
        </ul>
      </header>
      <section>
        <h2>HttpClient</h2>

<p>HttpClient wraps Go's built in HTTP client providing an API to:</p>

<ul>
<li>set timeouts

<ul>
<li>separate connect timeout</li>
<li>
<em>request</em> based timeout (*not* just read/write deadline)</li>
</ul>
</li>
<li>easy access to the connection object for a given request</li>
</ul><div class="highlight"><pre><span class="k">package</span> <span class="n">httpclient</span>

<span class="k">type</span> <span class="n">HttpClient</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">ConnectTimeout</span>   <span class="n">time</span><span class="p">.</span><span class="n">Duration</span>
    <span class="n">ReadWriteTimeout</span> <span class="n">time</span><span class="p">.</span><span class="n">Duration</span>
    <span class="n">MaxConnsPerHost</span>  <span class="nb">int</span>
    <span class="n">RedirectPolicy</span>   <span class="k">func</span><span class="p">(*</span><span class="n">http</span><span class="p">.</span><span class="n">Request</span><span class="p">,</span> <span class="p">[]*</span><span class="n">http</span><span class="p">.</span><span class="n">Request</span><span class="p">)</span> <span class="n">error</span>
    <span class="n">TLSClientConfig</span>  <span class="p">*</span><span class="n">tls</span><span class="p">.</span><span class="n">Config</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">New</span><span class="p">()</span> <span class="p">*</span><span class="n">HttpClient</span>
    <span class="n">create</span> <span class="n">a</span> <span class="nb">new</span> <span class="n">HttpClient</span> <span class="n">all</span> <span class="n">options</span> <span class="n">should</span> <span class="n">be</span> <span class="n">set</span> <span class="n">on</span> <span class="n">the</span> <span class="n">instance</span>
    <span class="n">returned</span>

<span class="k">func</span> <span class="p">(</span><span class="n">h</span> <span class="p">*</span><span class="n">HttpClient</span><span class="p">)</span> <span class="n">Do</span><span class="p">(</span><span class="n">req</span> <span class="p">*</span><span class="n">http</span><span class="p">.</span><span class="n">Request</span><span class="p">)</span> <span class="p">(*</span><span class="n">http</span><span class="p">.</span><span class="n">Response</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>
    <span class="n">perform</span> <span class="n">the</span> <span class="n">specified</span> <span class="n">request</span>

<span class="k">func</span> <span class="p">(</span><span class="n">h</span> <span class="p">*</span><span class="n">HttpClient</span><span class="p">)</span> <span class="n">FinishRequest</span><span class="p">(</span><span class="n">req</span> <span class="p">*</span><span class="n">http</span><span class="p">.</span><span class="n">Request</span><span class="p">)</span> <span class="n">error</span>
    <span class="n">perform</span> <span class="n">final</span> <span class="n">cleanup</span> <span class="k">for</span> <span class="n">the</span> <span class="n">specified</span> <span class="n">request</span> <span class="p">*</span><span class="n">must</span><span class="p">*</span> <span class="n">be</span> <span class="n">called</span> <span class="k">for</span>
    <span class="n">every</span> <span class="n">request</span> <span class="n">performed</span> <span class="n">after</span> <span class="n">processing</span> <span class="n">is</span> <span class="n">finished</span> <span class="n">and</span> <span class="n">after</span> <span class="n">which</span>
    <span class="n">GetConn</span> <span class="n">will</span> <span class="n">no</span> <span class="n">longer</span> <span class="k">return</span> <span class="n">successfully</span>

<span class="k">func</span> <span class="p">(</span><span class="n">h</span> <span class="p">*</span><span class="n">HttpClient</span><span class="p">)</span> <span class="n">Get</span><span class="p">(</span><span class="n">url</span> <span class="nb">string</span><span class="p">)</span> <span class="p">(*</span><span class="n">http</span><span class="p">.</span><span class="n">Response</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>
    <span class="n">convenience</span> <span class="n">method</span> <span class="n">to</span> <span class="n">perform</span> <span class="n">a</span> <span class="n">HTTP</span> <span class="n">GET</span> <span class="n">request</span>

<span class="k">func</span> <span class="p">(</span><span class="n">h</span> <span class="p">*</span><span class="n">HttpClient</span><span class="p">)</span> <span class="n">GetConn</span><span class="p">(</span><span class="n">req</span> <span class="p">*</span><span class="n">http</span><span class="p">.</span><span class="n">Request</span><span class="p">)</span> <span class="p">(</span><span class="n">net</span><span class="p">.</span><span class="n">Conn</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>
    <span class="n">returns</span> <span class="n">the</span> <span class="n">connection</span> <span class="n">associated</span> <span class="n">with</span> <span class="n">the</span> <span class="n">specified</span> <span class="n">request</span> <span class="n">cannot</span> <span class="n">be</span>
    <span class="n">called</span> <span class="n">after</span> <span class="n">FinishRequest</span>

<span class="k">func</span> <span class="p">(</span><span class="n">h</span> <span class="p">*</span><span class="n">HttpClient</span><span class="p">)</span> <span class="n">Post</span><span class="p">(</span><span class="n">url</span> <span class="nb">string</span><span class="p">,</span> <span class="n">contentType</span> <span class="nb">string</span><span class="p">,</span> <span class="n">body</span> <span class="n">io</span><span class="p">.</span><span class="n">Reader</span><span class="p">)</span> <span class="p">(*</span><span class="n">http</span><span class="p">.</span><span class="n">Response</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>
    <span class="n">convenience</span> <span class="n">method</span> <span class="n">to</span> <span class="n">perform</span> <span class="n">a</span> <span class="n">HTTP</span> <span class="n">POST</span> <span class="n">request</span>

<span class="k">func</span> <span class="p">(</span><span class="n">h</span> <span class="p">*</span><span class="n">HttpClient</span><span class="p">)</span> <span class="n">RoundTrip</span><span class="p">(</span><span class="n">req</span> <span class="p">*</span><span class="n">http</span><span class="p">.</span><span class="n">Request</span><span class="p">)</span> <span class="p">(*</span><span class="n">http</span><span class="p">.</span><span class="n">Response</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>
    <span class="n">satisfies</span> <span class="n">the</span> <span class="n">RoundTripper</span> <span class="k">interface</span> <span class="n">and</span> <span class="n">handles</span> <span class="n">checking</span> <span class="n">the</span> <span class="n">connection</span>
    <span class="n">cache</span> <span class="n">or</span> <span class="n">dialing</span> <span class="p">(</span><span class="n">with</span> <span class="n">ConnectTimeout</span><span class="p">)</span>

<span class="k">func</span> <span class="n">DefaultRedirectPolicy</span><span class="p">(</span><span class="n">req</span> <span class="p">*</span><span class="n">http</span><span class="p">.</span><span class="n">Request</span><span class="p">,</span> <span class="n">via</span> <span class="p">[]*</span><span class="n">http</span><span class="p">.</span><span class="n">Request</span><span class="p">)</span> <span class="n">error</span>
    <span class="k">default</span> <span class="n">redirect</span> <span class="n">policy</span> <span class="n">which</span> <span class="n">fails</span> <span class="n">after</span> <span class="mi">3</span> <span class="n">redirects</span><span class="p">.</span>

<span class="k">func</span> <span class="n">Version</span><span class="p">()</span> <span class="nb">string</span>
    <span class="n">returns</span> <span class="n">the</span> <span class="n">current</span> <span class="n">version</span>
</pre></div>

<h4>Example</h4>

<div class="highlight"><pre><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
    <span class="s">"httpclient"</span>
    <span class="s">"io/ioutil"</span>
    <span class="s">"log"</span>
    <span class="s">"net/http"</span>
    <span class="s">"time"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">httpClient</span> <span class="p">:=</span> <span class="n">httpclient</span><span class="p">.</span><span class="n">New</span><span class="p">()</span>
    <span class="n">httpClient</span><span class="p">.</span><span class="n">ConnectTimeout</span> <span class="p">=</span> <span class="n">time</span><span class="p">.</span><span class="n">Second</span>
    <span class="n">httpClient</span><span class="p">.</span><span class="n">ReadWriteTimeout</span> <span class="p">=</span> <span class="n">time</span><span class="p">.</span><span class="n">Second</span>

    <span class="c1">// Allow insecure HTTPS connections.  Note: the TLSClientConfig pointer can't change</span>
    <span class="c1">// places, so you can only modify the existing tls.Config object</span>
    <span class="n">httpClient</span><span class="p">.</span><span class="n">TLSClientConfig</span><span class="p">.</span><span class="n">InsecureSkipVerify</span> <span class="p">=</span> <span class="n">true</span>

    <span class="c1">// Make a custom redirect policy to keep track of the number of redirects we've followed</span>
    <span class="k">var</span> <span class="n">numRedirects</span> <span class="nb">int</span>
    <span class="n">httpClient</span><span class="p">.</span><span class="n">RedirectPolicy</span> <span class="p">=</span> <span class="k">func</span><span class="p">(</span><span class="n">r</span> <span class="p">*</span><span class="n">http</span><span class="p">.</span><span class="n">Request</span><span class="p">,</span> <span class="n">v</span> <span class="p">[]*</span><span class="n">http</span><span class="p">.</span><span class="n">Request</span><span class="p">)</span> <span class="n">error</span> <span class="p">{</span>
        <span class="n">numRedirects</span> <span class="p">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">DefaultRedirectPolicy</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="n">req</span><span class="p">,</span> <span class="n">_</span> <span class="p">:=</span> <span class="n">http</span><span class="p">.</span><span class="n">NewRequest</span><span class="p">(</span><span class="s">"GET"</span><span class="p">,</span> <span class="s">"http://127.0.0.1/test"</span><span class="p">,</span> <span class="n">nil</span><span class="p">)</span>

    <span class="n">resp</span><span class="p">,</span> <span class="n">err</span> <span class="p">:=</span> <span class="n">httpClient</span><span class="p">.</span><span class="n">Do</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">err</span> <span class="p">!=</span> <span class="n">nil</span> <span class="p">{</span>
        <span class="n">log</span><span class="p">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"request failed - %s"</span><span class="p">,</span> <span class="n">err</span><span class="p">.</span><span class="n">Error</span><span class="p">())</span>
    <span class="p">}</span>
    <span class="k">defer</span> <span class="n">resp</span><span class="p">.</span><span class="n">Body</span><span class="p">.</span><span class="n">Close</span><span class="p">()</span>

    <span class="n">conn</span><span class="p">,</span> <span class="n">err</span> <span class="p">:=</span> <span class="n">httpClient</span><span class="p">.</span><span class="n">GetConn</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">err</span> <span class="p">!=</span> <span class="n">nil</span> <span class="p">{</span>
        <span class="n">log</span><span class="p">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"failed to get conn for req"</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="c1">// do something with conn</span>

    <span class="n">body</span><span class="p">,</span> <span class="n">err</span> <span class="p">:=</span> <span class="n">ioutil</span><span class="p">.</span><span class="n">ReadAll</span><span class="p">(</span><span class="n">resp</span><span class="p">.</span><span class="n">Body</span><span class="p">)</span>
    <span class="n">log</span><span class="p">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"%s"</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>

    <span class="n">httpClient</span><span class="p">.</span><span class="n">FinishRequest</span><span class="p">(</span><span class="n">req</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
      </section>
    </div>
    <footer>
      <p>Project maintained by <a href="https://github.com/mreiferson">mreiferson</a></p>
      <p>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></p>
    </footer>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
    
  </body>
</html>